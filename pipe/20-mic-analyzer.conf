# 20-mic-analyzer.conf
# --------------------------------------------------
# Provides a new PipeWire *source* called “mic-analyzer”.
# The chain:
#   ES8316 codec  ➜  fast-lookahead limiter  ➜  any PipeWire app
#
# Install the DSP plugin package first:
#   sudo apt install swh-plugins

context.modules = [
  { name = libpipewire-module-filter-chain
    args = {
      # Node identity
      node.name        = "mic-analyzer"
      node.description = "ES8316 mic → fast limiter"

      # Force the same format the codec delivers (keeps resampler off)
      audio.rate       = 48000       # ES8316 default
      audio.channels   = 1           # mono codec
      audio.format     = S16

      # Which physical source to tap
      capture.props = {
        target.object = "alsa_input.platform-es8316-sound.HiFi__hw_rockchipes8316__source"
      }

      # Make the output appear as a passive monitor‐type source
      playback.props = { node.passive = true }

      # ---------- DSP graph ----------
      filter.graph = {
        nodes = [
          {
            # Use LADSPA instead of the missing builtin 'audiofx'
            type   = ladspa                     # <- plugin type
            plugin = "/usr/lib/ladspa/fast_lookahead_limiter_1913.so"
            label  = "fastLookaheadLimiter"     # factory inside the .so
            name   = "limiter"

            # Controls correspond to the LADSPA port names
            control = {
              InputGain_dB  = 0.0     # pre-gain
              Limit_dB      = -1.0    # ceiling (–1 dBFS)
              ReleaseTime_s = 0.25    # release in seconds
            }
          }
        ]
      }
      # Optional: write wet+dry mix to a debug file for inspection
      debug.wav-path = "/tmp/final.wav"
    }
  }
]
